<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game Details</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <header style="text-align: center; margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <a href="index.html" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: all 0.2s;">
                    ← Back to Games
                </a>
                <h1 id="gameTitle" style="color: white; font-size: 2.2em; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Game Details</h1>
                <div style="width: 120px;"></div>
            </div>
        </header>
        
        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px; align-items: start;">
            <!-- Game Info Card -->
            <div style="background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
                <div style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; padding: 20px;">
                    <h2 style="margin: 0; font-size: 1.5em;">Game Information</h2>
                </div>
                
                <div id="gameInfo" style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #495057; font-size: 1.1em;">Players</h3>
                            <div id="players" style="color: #6c757d;">Loading...</div>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #495057; font-size: 1.1em;">Event</h3>
                            <div id="event" style="color: #6c757d;">Loading...</div>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #495057; font-size: 1.1em;">Date</h3>
                            <div id="date" style="color: #6c757d;">Loading...</div>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #495057; font-size: 1.1em;">Site</h3>
                            <div id="site" style="color: #6c757d;">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Current Board State -->
            <div style="background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; position: sticky; top: 20px;">
                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; text-align: center;">
                    <h3 style="margin: 0; font-size: 1.2em;">Current Position</h3>
                    <div id="currentMoveInfo" style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;">Click a move to view position</div>
                </div>
                <div id="boardContainer" style="padding: 20px; text-align: center;">
                    <div style="color: #6c757d; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">♟️</div>
                        <p>Select a move to view the board position</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Moves List -->
        <div style="background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; margin-top: 20px;">
            <div style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; padding: 20px;">
                <h2 style="margin: 0; font-size: 1.5em;">Game Moves</h2>
                <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">Click any move to view the board position at that moment</div>
            </div>
            
            <div style="padding: 0;">
                <div id="loading" style="text-align: center; padding: 60px; color: #666; display: block;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #6f42c1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 20px; font-size: 1.1em;">Loading moves...</p>
                </div>
                
                <div id="movesContainer" style="display: none; padding: 20px;">
                    <div id="movesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;">
                    </div>
                </div>
                
                <div id="error" style="text-align: center; padding: 60px; color: #dc3545; display: none;">
                    <div style="font-size: 3em; margin-bottom: 20px;">⚠️</div>
                    <h3 style="margin: 0 0 10px 0;">Error Loading Game</h3>
                    <p style="margin: 0; color: #6c757d;">Game not found or API unavailable</p>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .move-button {
            background: #f8f9fa !important;
            border: 2px solid #dee2e6 !important;
            padding: 12px 8px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            text-align: center !important;
            transition: all 0.2s !important;
            font-family: 'Courier New', monospace !important;
            font-size: 0.9em !important;
            color: #495057 !important;
            text-decoration: none !important;
            display: block !important;
        }
        
        .move-button:hover {
            background: #e9ecef !important;
            border-color: #6f42c1 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.2) !important;
        }
        
        .move-button.active {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%) !important;
            color: white !important;
            border-color: #6f42c1 !important;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3) !important;
        }
        
        .move-number {
            font-size: 0.8em !important;
            color: #6c757d !important;
            display: block !important;
            margin-bottom: 4px !important;
        }
        
        .move-button.active .move-number {
            color: rgba(255,255,255,0.8) !important;
        }
        
        a[href*="index.html"]:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: translateY(-1px) !important;
        }
    </style>

    <script>
        let gameData = null;
        let movesData = [];
        let currentMoveIndex = -1;
        
        async function loadGame() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            
            if (!gameId) {
                showError();
                return;
            }
            
            try {
                // Fetch game info and moves
                const [gameResponse, movesResponse] = await Promise.all([
                    fetch(`/api/games/${gameId}`),
                    fetch(`/api/games/${gameId}/moves`)
                ]);
                
                if (!gameResponse.ok || !movesResponse.ok) {
                    throw new Error('Failed to fetch game data');
                }
                
                gameData = await gameResponse.json();
                movesData = await movesResponse.json();
                
                renderGameInfo();
                renderMoves();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('movesContainer').style.display = 'block';
                
            } catch (err) {
                console.error('Error loading game:', err);
                showError();
            }
        }
        
        function renderGameInfo() {
            document.getElementById('gameTitle').textContent = gameData.event || 'Chess Game';
            document.getElementById('players').innerHTML = `
                <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 5px;">
                    <span style="color: #212529;">⚪ ${gameData.white || 'Unknown'}</span>
                </div>
                <div style="font-weight: 600; font-size: 1.1em;">
                    <span style="color: #212529;">⚫ ${gameData.black || 'Unknown'}</span>
                </div>
            `;
            document.getElementById('event').textContent = gameData.event || 'Unknown Event';
            document.getElementById('date').textContent = gameData.date || 'Unknown Date';
            document.getElementById('site').textContent = gameData.site || 'Unknown Site';
        }
        
        function renderMoves() {
            const movesList = document.getElementById('movesList');
            movesList.innerHTML = '';
            
            movesData.forEach((move, index) => {
                const moveButton = document.createElement('a');
                moveButton.href = '#';
                moveButton.className = 'move-button';
                moveButton.onclick = (e) => {
                    e.preventDefault();
                    selectMove(index);
                };
                
                const moveNumber = Math.ceil((index + 1) / 2);
                const isWhiteMove = (index % 2) === 0;
                const displayNumber = isWhiteMove ? `${moveNumber}.` : `${moveNumber}...`;
                
                moveButton.innerHTML = `
                    <span class="move-number">${displayNumber}</span>
                    <div>${move.acn}</div>
                `;
                
                movesList.appendChild(moveButton);
            });
        }
        
        async function selectMove(index) {
            // Update active move styling
            document.querySelectorAll('.move-button').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            currentMoveIndex = index;
            const move = movesData[index];
            
            // Update current move info
            const moveNumber = Math.ceil((index + 1) / 2);
            const isWhiteMove = (index % 2) === 0;
            const player = isWhiteMove ? 'White' : 'Black';
            const displayNumber = isWhiteMove ? `${moveNumber}.` : `${moveNumber}...`;
            
            document.getElementById('currentMoveInfo').innerHTML = `
                Move ${displayNumber} ${move.acn} (${player})
            `;
            
            // Load board state
            try {
                const boardResponse = await fetch(`/render_board?fen=${encodeURIComponent(move.fen_after)}`);
                if (boardResponse.ok) {
                    const boardHtml = await boardResponse.text();
                    document.getElementById('boardContainer').innerHTML = boardHtml;
                } else {
                    document.getElementById('boardContainer').innerHTML = `
                        <div style="color: #dc3545; padding: 40px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">❌</div>
                            <p>Could not load board position</p>
                            <p style="font-size: 0.8em; color: #6c757d;">FEN: ${move.fen_after}</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error loading board:', err);
                document.getElementById('boardContainer').innerHTML = `
                    <div style="color: #dc3545; padding: 40px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">❌</div>
                        <p>Error loading board position</p>
                    </div>
                `;
            }
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        // Load game when page loads
        document.addEventListener('DOMContentLoaded', loadGame);
    </script>
</body>
</html>